{% extends "base.html" %}

{% block title %}Step 3: Learning Objectives - Adaptive Learning Design Engine{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Progress Indicator -->
    {% set step = 3 %}
    {% include "partials/progress.html" %}

    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-2xl font-bold text-gray-900">Step 3: Learning Objectives & Assessment</h2>
        <p class="text-gray-600 mt-2">
            Review and customize the learning objectives and assessment strategy for
            <strong>{{ data.project.project_title }}</strong>.
        </p>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="bg-white rounded-lg shadow-sm border border-gray-200 p-12">
        <div class="flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            <p class="mt-4 text-gray-600">Generating learning objectives and assessment strategy...</p>
            <p class="mt-2 text-sm text-gray-500">This may take a few moments.</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden bg-red-50 rounded-lg border border-red-200 p-6">
        <div class="flex items-start">
            <svg class="w-6 h-6 text-red-600 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <h3 class="text-red-800 font-medium">Error generating objectives</h3>
                <p id="error-message" class="text-red-700 mt-1"></p>
                <button onclick="generateObjectives()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Content State -->
    <div id="content-state" class="hidden space-y-6">
        <!-- Learning Objectives -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Learning Objectives</h3>
            </div>
            <div class="p-6 space-y-6">
                <!-- Professional Skills Objectives -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Professional Skills Objectives</h4>
                    <div id="fixed-objectives" class="space-y-2"></div>
                </div>

                <!-- Project-Specific Objectives -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Project-Specific Objectives</h4>
                    <div id="variable-objectives" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Assessment Strategy -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Assessment Strategy</h3>
            </div>
            <div class="p-6 space-y-6">
                <!-- Grading Breakdown -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Grading Breakdown</h4>
                    <div id="grading-breakdown" class="space-y-2"></div>
                </div>

                <!-- Rubric Criteria -->
                <div>
                    <h4 class="font-medium text-gray-900 mb-3">Evaluation Criteria</h4>
                    <div id="rubric-criteria" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="{{ url_for('back_to_confirm') }}" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    &larr; Back to Review
                </a>
                <button onclick="regenerateObjectives()" id="regenerate-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Regenerate
                </button>
            </div>
            <form method="POST" action="{{ url_for('outline_page') }}" id="continue-form">
                <input type="hidden" name="objectives_data" id="objectives-data">
                <input type="hidden" name="assessment_data" id="assessment-data">
                <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    Continue to Outline &rarr;
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let objectivesData = null;
    let assessmentData = null;

    // Generate objectives on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we already have data in session (coming back from later step)
        {% if objectives %}
        objectivesData = {{ objectives | tojson }};
        assessmentData = {{ assessment_strategy | tojson }};
        renderContent();
        {% else %}
        generateObjectives();
        {% endif %}
    });

    async function generateObjectives() {
        showLoading();

        try {
            const response = await fetch('/api/objectives/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.error) {
                showError(data.error);
                return;
            }

            objectivesData = data.objectives;
            assessmentData = data.assessment_strategy;
            renderContent();

        } catch (error) {
            showError('Network error: ' + error.message);
        }
    }

    async function regenerateObjectives() {
        const btn = document.getElementById('regenerate-btn');
        btn.disabled = true;
        btn.textContent = 'Regenerating...';

        await generateObjectives();

        btn.disabled = false;
        btn.textContent = 'Regenerate';
    }

    function showLoading() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('content-state').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('content-state').classList.add('hidden');
        document.getElementById('error-message').textContent = message;
    }

    function renderContent() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('content-state').classList.remove('hidden');

        // Render fixed objectives
        const fixedContainer = document.getElementById('fixed-objectives');
        fixedContainer.innerHTML = '';
        (objectivesData.fixed_objectives || []).forEach((obj, index) => {
            const text = typeof obj === 'string' ? obj : obj.text;
            const div = document.createElement('div');
            div.className = 'flex items-start p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <span class="flex-shrink-0 w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs mr-3">${index + 1}</span>
                <span class="text-gray-700">${text}</span>
            `;
            fixedContainer.appendChild(div);
        });

        // Render variable objectives
        const varContainer = document.getElementById('variable-objectives');
        varContainer.innerHTML = '';
        (objectivesData.variable_objectives || []).forEach((obj, index) => {
            const text = typeof obj === 'string' ? obj : obj.text;
            const bloom = typeof obj === 'object' ? obj.bloom_level : '';
            const div = document.createElement('div');
            div.className = 'flex items-start p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <span class="flex-shrink-0 w-6 h-6 bg-secondary text-white rounded-full flex items-center justify-center text-xs mr-3">${index + 1}</span>
                <div>
                    <span class="text-gray-700">${text}</span>
                    ${bloom ? `<span class="ml-2 text-xs px-2 py-0.5 bg-primary/10 text-primary rounded">${bloom}</span>` : ''}
                </div>
            `;
            varContainer.appendChild(div);
        });

        // Render grading breakdown
        const gradingContainer = document.getElementById('grading-breakdown');
        gradingContainer.innerHTML = '';
        const grading = assessmentData.grading_breakdown || {};
        for (const [key, value] of Object.entries(grading)) {
            const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            const weight = typeof value === 'object' ? value.weight : value;
            const desc = typeof value === 'object' ? value.description : '';
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <div>
                    <span class="font-medium text-gray-900">${label}</span>
                    ${desc ? `<p class="text-sm text-gray-500">${desc}</p>` : ''}
                </div>
                <span class="text-lg font-bold text-primary">${weight}%</span>
            `;
            gradingContainer.appendChild(div);
        }

        // Render rubric criteria
        const rubricContainer = document.getElementById('rubric-criteria');
        rubricContainer.innerHTML = '';
        const criteria = [
            ...(assessmentData.deliverable_rubric_criteria || []),
            ...(assessmentData.reflection_rubric_criteria || [])
        ];
        criteria.forEach(crit => {
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
                <span class="font-medium text-gray-900">${crit.criterion || crit}</span>
                ${crit.description ? `<p class="text-sm text-gray-500 mt-1">${crit.description}</p>` : ''}
            `;
            rubricContainer.appendChild(div);
        });

        // Set hidden form data
        document.getElementById('objectives-data').value = JSON.stringify(objectivesData);
        document.getElementById('assessment-data').value = JSON.stringify(assessmentData);
    }
</script>
{% endblock %}
