{% extends "base.html" %}

{% block title %}Step 5: Final Document | Adaptive Learning Design Engine{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Progress Indicator -->
    {% set step = 5 %}
    {% include "partials/progress.html" %}

    <!-- Success Banner -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <h3 class="font-medium text-green-800">Course Document Generated</h3>
                <p class="text-sm text-green-700">Your course shell is ready. Download or copy below.</p>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-center gap-4">
                <a href="{{ url_for('outline_page') }}" class="text-sm text-gray-600 hover:text-primary">
                    &larr; Back to Outline
                </a>
                <a href="{{ url_for('intake_form') }}" class="text-sm text-gray-600 hover:text-primary">
                    Start New Course
                </a>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="copyToClipboard()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                    </svg>
                    Copy
                </button>
                <!-- Download Dropdown -->
                <div class="relative" id="download-dropdown">
                    <button onclick="toggleDropdown()" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                        <a href="{{ url_for('download_curriculum') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg">
                            <span class="font-medium">Markdown</span>
                            <span class="text-gray-500 text-xs ml-1">(.md)</span>
                        </a>
                        <a href="{{ url_for('download_word') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-lg">
                            <span class="font-medium">Word Document</span>
                            <span class="text-gray-500 text-xs ml-1">(.docx)</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Content -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-8">
        <div class="prose prose-indigo max-w-none">
            {{ curriculum_html|safe }}
        </div>
    </div>

    <!-- Print Hint -->
    <p class="text-center text-sm text-gray-500 mb-8">
        Need a PDF? Use your browser's print function (Ctrl/Cmd + P) and select "Save as PDF"
    </p>

    <!-- Hidden textarea for clipboard -->
    <textarea id="markdown-content" class="hidden">{{ curriculum_markdown }}</textarea>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-900 text-white rounded-lg shadow-lg opacity-0 transition-opacity pointer-events-none">
    Copied to clipboard!
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle download dropdown
    function toggleDropdown() {
        const menu = document.getElementById('dropdown-menu');
        menu.classList.toggle('hidden');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('download-dropdown');
        if (!dropdown.contains(e.target)) {
            document.getElementById('dropdown-menu').classList.add('hidden');
        }
    });

    // Copy to clipboard
    function copyToClipboard() {
        const content = document.getElementById('markdown-content').value;
        navigator.clipboard.writeText(content).then(() => {
            showToast('Copied to clipboard!');
        }).catch(() => {
            // Fallback for older browsers
            const textarea = document.getElementById('markdown-content');
            textarea.classList.remove('hidden');
            textarea.select();
            document.execCommand('copy');
            textarea.classList.add('hidden');
            showToast('Copied to clipboard!');
        });
    }

    // Show toast notification
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');
        setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
        }, 2000);
    }
</script>

<style>
    /* Clean prose styling */
    .prose h1 {
        @apply text-2xl font-bold text-gray-900 pb-3 mb-6 border-b-2 border-gray-200;
    }
    .prose h2 {
        @apply text-xl font-bold text-gray-900 mt-8 mb-4 pb-2 border-b border-gray-200;
    }
    .prose h3 {
        @apply text-lg font-semibold text-gray-800 mt-6 mb-3;
    }
    .prose p {
        @apply text-gray-600 mb-4 leading-relaxed;
    }
    .prose ul, .prose ol {
        @apply my-4 pl-6 space-y-2;
    }
    .prose li {
        @apply text-gray-600;
    }
    .prose strong {
        @apply font-semibold text-gray-800;
    }
</style>
{% endblock %}
