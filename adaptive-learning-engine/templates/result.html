{% extends "base.html" %}

{% block title %}Generated Course | Adaptive Learning Design Engine{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Progress Indicator -->
    <div class="mb-8">
        <div class="flex items-center justify-center space-x-4">
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <span class="ml-2 text-green-600">Input Details</span>
            </div>
            <div class="w-16 h-1 bg-green-500"></div>
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <span class="ml-2 text-green-600">Review & Confirm</span>
            </div>
            <div class="w-16 h-1 bg-green-500"></div>
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">3</div>
                <span class="ml-2 font-medium text-primary">Generated Course</span>
            </div>
        </div>
    </div>

    <!-- Success Banner -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <svg class="w-6 h-6 text-green-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <h3 class="font-medium text-green-800">Course Shell Generated Successfully</h3>
                <p class="text-sm text-green-700">Your complete curriculum is ready. Download or review below.</p>
            </div>
        </div>
    </div>

    <div class="flex gap-6">
        <!-- Table of Contents Sidebar -->
        <div class="hidden lg:block w-64 flex-shrink-0">
            <div class="sticky top-4">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">Jump to Section</h3>
                    <nav class="space-y-1 text-sm" id="toc">
                        <a href="#learning-objectives" class="toc-link block py-2 px-3 text-gray-600 hover:text-primary hover:bg-gray-50 rounded flex items-center">
                            <span class="mr-2">ðŸŽ¯</span> Learning Objectives
                        </a>
                        <a href="#weekly-schedule" class="toc-link block py-2 px-3 text-gray-600 hover:text-primary hover:bg-gray-50 rounded flex items-center">
                            <span class="mr-2">ðŸ“…</span> Weekly Schedule
                        </a>
                        <a href="#assessment-package" class="toc-link block py-2 px-3 text-gray-600 hover:text-primary hover:bg-gray-50 rounded flex items-center">
                            <span class="mr-2">ðŸ“‹</span> Assessment Package
                        </a>
                        <a href="#grading-breakdown" class="toc-link block py-2 px-3 text-gray-600 hover:text-primary hover:bg-gray-50 rounded flex items-center">
                            <span class="mr-2">ðŸ“Š</span> Grading Breakdown
                        </a>
                    </nav>
                </div>

                <!-- Action Buttons -->
                <div class="mt-4 space-y-2">
                    <a href="{{ url_for('download_curriculum') }}" class="flex items-center justify-center w-full px-4 py-3 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Markdown
                    </a>
                    <button onclick="copyToClipboard()" class="flex items-center justify-center w-full px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                        </svg>
                        Copy to Clipboard
                    </button>
                </div>

                <!-- Navigation Links -->
                <div class="mt-4 space-y-2 text-sm">
                    <a href="{{ url_for('back_to_confirm') }}" class="block text-gray-600 hover:text-primary">
                        &larr; Edit Inputs
                    </a>
                    <a href="{{ url_for('intake_form') }}" class="block text-gray-600 hover:text-primary">
                        Start New Course
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 min-w-0">
            <!-- Mobile Actions -->
            <div class="lg:hidden mb-4 flex gap-2">
                <a href="{{ url_for('download_curriculum') }}" class="flex-1 flex items-center justify-center px-4 py-2 bg-primary text-white font-medium rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download
                </a>
                <button onclick="copyToClipboard()" class="flex-1 flex items-center justify-center px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                    </svg>
                    Copy
                </button>
            </div>

            <!-- Quick Actions Bar (Mobile + Desktop) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button onclick="toggleAllSections()" id="toggleAllBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                        <span id="toggleAllText">Expand All</span>
                    </button>
                    <span class="text-sm text-gray-500 hidden sm:inline" id="sectionCount">6 sections</span>
                </div>
                <a href="{{ url_for('download_curriculum') }}" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download
                </a>
            </div>

            <!-- Curriculum Content (will be transformed into collapsible sections) -->
            <div class="curriculum-content" id="curriculum-container">
                <div class="prose prose-indigo max-w-none hidden" id="original-content">
                    {{ curriculum_html|safe }}
                </div>
                <div id="collapsible-sections"></div>
            </div>

            <!-- Mobile Navigation -->
            <div class="lg:hidden mt-6 flex justify-between">
                <a href="{{ url_for('back_to_confirm') }}" class="text-gray-600 hover:text-primary">
                    &larr; Edit Inputs
                </a>
                <a href="{{ url_for('intake_form') }}" class="text-primary hover:underline">
                    Start New Course
                </a>
            </div>
        </div>
    </div>

    <!-- Hidden textarea for clipboard -->
    <textarea id="markdown-content" class="hidden">{{ curriculum_markdown }}</textarea>
</div>

<!-- Back to Top Button -->
<button id="back-to-top" class="fixed bottom-8 right-8 p-3 bg-primary text-white rounded-full shadow-lg opacity-0 transition-opacity hover:bg-indigo-700" onclick="scrollToTop()">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
    </svg>
</button>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-900 text-white rounded-lg shadow-lg opacity-0 transition-opacity">
    Copied to clipboard!
</div>
{% endblock %}

{% block scripts %}
<script>
    // Section configuration with colors and icons
    const sectionConfig = {
        'course': { color: 'blue', icon: 'ðŸ“š', title: 'Course Header' },
        'learning': { color: 'green', icon: 'ðŸŽ¯', title: 'Learning Objectives' },
        'weekly': { color: 'purple', icon: 'ðŸ“…', title: 'Weekly Schedule' },
        'reflection': { color: 'amber', icon: 'ðŸ’­', title: 'Reflection Prompts' },
        'assessment': { color: 'teal', icon: 'ðŸ“‹', title: 'Assessment Package' },
        'grading': { color: 'indigo', icon: 'ðŸ“Š', title: 'Grading Breakdown' }
    };

    // Color classes for each section type
    const colorClasses = {
        'blue': { header: 'bg-blue-50 border-blue-200', title: 'text-blue-800', icon: 'bg-blue-100' },
        'green': { header: 'bg-green-50 border-green-200', title: 'text-green-800', icon: 'bg-green-100' },
        'purple': { header: 'bg-purple-50 border-purple-200', title: 'text-purple-800', icon: 'bg-purple-100' },
        'amber': { header: 'bg-amber-50 border-amber-200', title: 'text-amber-800', icon: 'bg-amber-100' },
        'teal': { header: 'bg-teal-50 border-teal-200', title: 'text-teal-800', icon: 'bg-teal-100' },
        'indigo': { header: 'bg-indigo-50 border-indigo-200', title: 'text-indigo-800', icon: 'bg-indigo-100' }
    };

    // Determine section type from title
    function getSectionType(title) {
        const lowerTitle = title.toLowerCase();
        if (lowerTitle.includes('course') || lowerTitle.includes('header') || lowerTitle.includes('credit')) return 'course';
        if (lowerTitle.includes('learning') || lowerTitle.includes('objective')) return 'learning';
        if (lowerTitle.includes('weekly') || lowerTitle.includes('schedule') || lowerTitle.includes('week')) return 'weekly';
        if (lowerTitle.includes('reflection')) return 'reflection';
        if (lowerTitle.includes('assessment') || lowerTitle.includes('rubric') || lowerTitle.includes('evaluation')) return 'assessment';
        if (lowerTitle.includes('grading') || lowerTitle.includes('breakdown')) return 'grading';
        return 'blue'; // default
    }

    // Transform content into collapsible sections
    document.addEventListener('DOMContentLoaded', function() {
        const originalContent = document.getElementById('original-content');
        const sectionsContainer = document.getElementById('collapsible-sections');

        // Parse content and group by H2 sections
        const sections = [];
        let currentSection = null;
        let preContent = []; // Content before first H2

        Array.from(originalContent.children).forEach(node => {
            if (node.tagName === 'H2') {
                if (currentSection) {
                    sections.push(currentSection);
                }
                currentSection = {
                    title: node.textContent.trim(),
                    elements: [],
                    id: node.textContent.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')
                };
            } else if (currentSection) {
                currentSection.elements.push(node.cloneNode(true));
            } else {
                preContent.push(node.cloneNode(true));
            }
        });
        if (currentSection) {
            sections.push(currentSection);
        }

        // Add pre-content (usually H1 title) as expanded intro
        if (preContent.length > 0) {
            const introCard = document.createElement('div');
            introCard.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4';
            preContent.forEach(el => introCard.appendChild(el));
            sectionsContainer.appendChild(introCard);
        }

        // Build collapsible cards for each section
        sections.forEach((section, index) => {
            const sectionType = getSectionType(section.title);
            const config = sectionConfig[sectionType] || sectionConfig['course'];
            const colors = colorClasses[config.color] || colorClasses['blue'];

            const card = document.createElement('div');
            card.className = 'section-card bg-white rounded-lg shadow-sm border border-gray-200 mb-4 overflow-hidden';
            card.id = section.id;

            // Header
            const header = document.createElement('div');
            header.className = `section-header px-6 py-4 cursor-pointer flex items-center justify-between ${colors.header} border-b`;
            header.onclick = () => toggleSection(card);

            header.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-3">${config.icon}</span>
                    <h2 class="text-lg font-semibold ${colors.title}">${section.title}</h2>
                </div>
                <svg class="section-chevron w-5 h-5 ${colors.title} transform transition-transform ${index === 0 ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            `;

            // Content
            const content = document.createElement('div');
            content.className = `section-content p-6 prose prose-indigo max-w-none ${index === 0 ? '' : 'hidden'}`;
            section.elements.forEach(el => content.appendChild(el));

            // Style subheaders within Learning Objectives section
            if (section.title.toLowerCase().includes('learning objectives')) {
                content.querySelectorAll('h4').forEach(h4 => {
                    if (h4.textContent.toLowerCase().includes('fixed objectives')) {
                        h4.classList.add('objective-subheader', 'objective-fixed');
                    } else if (h4.textContent.toLowerCase().includes('variable objectives')) {
                        h4.classList.add('objective-subheader', 'objective-variable');
                    }
                });
            }

            // Style week headers within Weekly Schedule section
            if (section.title.toLowerCase().includes('weekly schedule')) {
                content.querySelectorAll('h3').forEach(h3 => {
                    if (h3.textContent.toLowerCase().startsWith('week')) {
                        h3.classList.add('week-header');
                    }
                });
            }

            card.appendChild(header);
            card.appendChild(content);
            sectionsContainer.appendChild(card);
        });

        // Update section count
        document.getElementById('sectionCount').textContent = `${sections.length} sections`;

        // Update ToC links to work with collapsible sections
        updateTocLinks();
    });

    // Toggle individual section
    function toggleSection(card) {
        const content = card.querySelector('.section-content');
        const chevron = card.querySelector('.section-chevron');
        content.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
    }

    // Toggle all sections
    let allExpanded = false; // Start with most collapsed
    function toggleAllSections() {
        allExpanded = !allExpanded;
        const cards = document.querySelectorAll('.section-card');
        cards.forEach(card => {
            const content = card.querySelector('.section-content');
            const chevron = card.querySelector('.section-chevron');
            if (allExpanded) {
                content.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        });
        document.getElementById('toggleAllText').textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }

    // Update ToC links to expand sections when clicked
    function updateTocLinks() {
        document.querySelectorAll('#toc a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetCard = document.getElementById(targetId);
                if (targetCard) {
                    // Expand the section
                    const content = targetCard.querySelector('.section-content');
                    const chevron = targetCard.querySelector('.section-chevron');
                    content.classList.remove('hidden');
                    chevron.classList.add('rotate-180');

                    // Scroll to it
                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Highlight in ToC
                    document.querySelectorAll('#toc a').forEach(l => {
                        l.classList.remove('bg-indigo-50', 'text-primary', 'font-medium');
                    });
                    this.classList.add('bg-indigo-50', 'text-primary', 'font-medium');
                }
            });
        });
    }

    // Copy to clipboard
    function copyToClipboard() {
        const content = document.getElementById('markdown-content').value;
        navigator.clipboard.writeText(content).then(() => {
            showToast('Copied to clipboard!');
        }).catch(() => {
            const textarea = document.getElementById('markdown-content');
            textarea.classList.remove('hidden');
            textarea.select();
            document.execCommand('copy');
            textarea.classList.add('hidden');
            showToast('Copied to clipboard!');
        });
    }

    // Show toast notification
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');
        setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
        }, 2000);
    }

    // Back to top button
    const backToTopBtn = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTopBtn.classList.remove('opacity-0');
            backToTopBtn.classList.add('opacity-100');
        } else {
            backToTopBtn.classList.remove('opacity-100');
            backToTopBtn.classList.add('opacity-0');
        }
    });

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>

<style>
    /* Prose styling for curriculum content */
    .prose h1 {
        @apply text-3xl font-bold text-gray-900 border-b border-gray-200 pb-4 mb-6;
    }
    .prose h2 {
        @apply text-2xl font-bold text-gray-800 mt-8 mb-4;
    }
    .prose h3 {
        @apply text-xl font-semibold text-gray-700 mt-6 mb-3;
    }
    .prose h4 {
        @apply text-lg font-medium text-gray-700 mt-4 mb-2;
    }

    /* Learning Objectives subheader styling */
    .objective-subheader {
        @apply text-base font-semibold py-2 px-4 rounded-lg mt-6 mb-4 border-l-4;
    }
    .objective-fixed {
        @apply bg-emerald-50 text-emerald-800 border-emerald-500;
    }
    .objective-variable {
        @apply bg-blue-50 text-blue-800 border-blue-500;
    }

    /* Week header styling within Weekly Schedule */
    .week-header {
        @apply text-lg font-semibold py-3 px-4 rounded-lg mt-6 mb-4 bg-purple-50 text-purple-800 border-l-4 border-purple-500;
    }
    .prose p {
        @apply text-gray-600 leading-relaxed mb-4;
    }
    .prose ul, .prose ol {
        @apply my-4 pl-6;
    }
    .prose li {
        @apply text-gray-600 mb-2;
    }
    .prose table {
        @apply w-full border-collapse border border-gray-300 my-6;
    }
    .prose th {
        @apply bg-gray-100 border border-gray-300 px-4 py-2 text-left font-semibold text-gray-700;
    }
    .prose td {
        @apply border border-gray-300 px-4 py-2 text-gray-600;
    }
    .prose code {
        @apply bg-gray-100 px-1 py-0.5 rounded text-sm;
    }
    .prose pre {
        @apply bg-gray-100 p-4 rounded-lg overflow-x-auto my-4;
    }
    .prose blockquote {
        @apply border-l-4 border-indigo-500 pl-4 my-4 italic text-gray-600;
    }
    .prose hr {
        @apply my-8 border-gray-200;
    }

    /* Section card hover effects */
    .section-header:hover {
        filter: brightness(0.97);
    }

    /* Smooth transitions */
    .section-content {
        transition: all 0.2s ease-in-out;
    }

    /* Print styles - expand all sections */
    @media print {
        .sticky, #back-to-top, #toast, .section-header svg {
            display: none !important;
        }
        .section-content {
            display: block !important;
        }
        .section-content.hidden {
            display: block !important;
        }
        .section-card {
            box-shadow: none !important;
            page-break-inside: avoid;
        }
        .curriculum-content {
            box-shadow: none !important;
            border: none !important;
        }
    }
</style>
{% endblock %}
