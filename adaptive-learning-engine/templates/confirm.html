{% extends "base.html" %}

{% block title %}Step 2: Review & Confirm | Adaptive Learning Design Engine{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Progress Indicator -->
    {% set step = 2 %}
    {% include "partials/progress.html" %}

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-start">
            <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <h3 class="font-medium text-blue-800">Review AI-Extracted Data</h3>
                <p class="text-sm text-blue-700 mt-1">We've analyzed the resume and project description. Review the extracted information below and make any corrections before generating the curriculum.</p>
            </div>
        </div>
    </div>

    <form action="{{ url_for('generate_curriculum') }}" method="POST" id="confirmForm">
        <!-- Hidden fields for raw data -->
        <input type="hidden" name="learner_name" value="{{ raw.learner.learner_name }}">
        <input type="hidden" name="academic_level" value="{{ raw.learner.academic_level }}">
        <input type="hidden" name="major_or_program" value="{{ raw.learner.major_or_program }}">
        <input type="hidden" name="career_goals" value="{{ raw.learner.career_goals }}">
        <input type="hidden" name="company_name" value="{{ raw.project.company_name }}">
        <input type="hidden" name="industry" value="{{ raw.project.industry }}">
        <input type="hidden" name="project_title" value="{{ raw.project.project_title }}">
        <input type="hidden" name="mentorship_level" value="{{ raw.project.mentorship_level }}">
        <input type="hidden" name="team_size" value="{{ raw.project.team_size }}">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Learner Column -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-100 rounded-lg p-2 mr-3">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900">Learner Profile</h2>
                </div>

                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-500">{{ raw.learner.learner_name or 'Student' }} | {{ raw.learner.academic_level }} | {{ raw.learner.major_or_program }}</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Technical Skills</label>
                        <div class="skill-tags flex flex-wrap gap-2" id="technical-skills">
                            {% for skill in learner.technical_skills %}
                                <span class="skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800 border border-blue-200">
                                    {{ skill.skill if skill.skill else skill }}
                                    <button type="button" class="ml-2 text-blue-600 hover:text-blue-800" onclick="removeTag(this)">&times;</button>
                                </span>
                            {% endfor %}
                            <button type="button" class="add-tag-btn inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 border border-dashed border-gray-300 hover:bg-gray-200" onclick="addTag('technical-skills', 'blue')">
                                + Add
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Professional Skills</label>
                        <div class="skill-tags flex flex-wrap gap-2" id="professional-skills">
                            {% for skill in learner.professional_skills %}
                                <span class="skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 border border-green-200">
                                    {{ skill.skill if skill.skill else skill }}
                                    <button type="button" class="ml-2 text-green-600 hover:text-green-800" onclick="removeTag(this)">&times;</button>
                                </span>
                            {% endfor %}
                            <button type="button" class="add-tag-btn inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 border border-dashed border-gray-300 hover:bg-gray-200" onclick="addTag('professional-skills', 'green')">
                                + Add
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Relevant Coursework</label>
                        <div class="skill-tags flex flex-wrap gap-2" id="coursework">
                            {% for course in learner.relevant_coursework %}
                                <span class="skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-800 border border-purple-200">
                                    {{ course }}
                                    <button type="button" class="ml-2 text-purple-600 hover:text-purple-800" onclick="removeTag(this)">&times;</button>
                                </span>
                            {% endfor %}
                            <button type="button" class="add-tag-btn inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 border border-dashed border-gray-300 hover:bg-gray-200" onclick="addTag('coursework', 'purple')">
                                + Add
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Experience Level</label>
                        <select name="experience_level" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="entry" {% if learner.experience_level == 'entry' %}selected{% endif %}>Entry Level</option>
                            <option value="some_experience" {% if learner.experience_level == 'some_experience' %}selected{% endif %}>Some Experience</option>
                            <option value="experienced" {% if learner.experience_level == 'experienced' %}selected{% endif %}>Experienced</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Experience Summary</label>
                        <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">{{ learner.work_experience_summary }}</p>
                    </div>
                </div>
            </div>

            <!-- Project Column -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-green-100 rounded-lg p-2 mr-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900">Project Details</h2>
                </div>

                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-500">{{ raw.project.company_name }} | {{ raw.project.industry }}</p>
                        <p class="font-medium text-gray-900">{{ raw.project.project_title }}</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project Summary</label>
                        <textarea name="confirmed_summary" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent">{{ project.project_summary }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deliverables</label>
                        <div class="space-y-2" id="deliverables-list">
                            {% for d in project.deliverables %}
                                <div class="deliverable-item flex items-center gap-2 bg-gray-50 p-2 rounded-lg">
                                    <span class="text-gray-400 cursor-move">&#9776;</span>
                                    <input type="text" value="{{ d.deliverable if d.deliverable else d }}" class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removeDeliverable(this)">&times;</button>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="mt-2 text-sm text-primary hover:underline" onclick="addDeliverable()">+ Add Deliverable</button>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Required Technical Skills</label>
                        <div class="skill-tags flex flex-wrap gap-2" id="project-technical-skills">
                            {% for skill in project.technical_skills_required %}
                                <span class="skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-100 text-orange-800 border border-orange-200">
                                    {{ skill.skill if skill.skill else skill }}
                                    <button type="button" class="ml-2 text-orange-600 hover:text-orange-800" onclick="removeTag(this)">&times;</button>
                                </span>
                            {% endfor %}
                            <button type="button" class="add-tag-btn inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 border border-dashed border-gray-300 hover:bg-gray-200" onclick="addTag('project-technical-skills', 'orange')">
                                + Add
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Success Criteria</label>
                        <div class="skill-tags flex flex-wrap gap-2" id="success-criteria">
                            {% for criterion in project.success_criteria %}
                                <span class="skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-teal-100 text-teal-800 border border-teal-200">
                                    {{ criterion }}
                                    <button type="button" class="ml-2 text-teal-600 hover:text-teal-800" onclick="removeTag(this)">&times;</button>
                                </span>
                            {% endfor %}
                            <button type="button" class="add-tag-btn inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 border border-dashed border-gray-300 hover:bg-gray-200" onclick="addTag('success-criteria', 'teal')">
                                + Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gap Analysis Column -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-amber-100 rounded-lg p-2 mr-3">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h2 class="text-lg font-semibold text-gray-900">Skill Gap Analysis</h2>
                </div>

                <div class="space-y-4">
                    <!-- Fit Assessment -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Overall Fit</span>
                            <span class="px-3 py-1 rounded-full text-sm font-medium
                                {% if gaps.fit_assessment.overall_fit == 'excellent' %}bg-green-100 text-green-800
                                {% elif gaps.fit_assessment.overall_fit == 'good' %}bg-blue-100 text-blue-800
                                {% elif gaps.fit_assessment.overall_fit == 'stretch' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ gaps.fit_assessment.overall_fit|capitalize }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600">{{ gaps.fit_assessment.rationale }}</p>
                        <input type="hidden" name="overall_fit" value="{{ gaps.fit_assessment.overall_fit }}">
                    </div>

                    <!-- Scaffolding Recommendation -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Scaffolding Level</label>
                        <select name="scaffolding_recommendation" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="minimal" {% if gaps.fit_assessment.scaffolding_recommendation == 'minimal' %}selected{% endif %}>Minimal - Independent with check-ins</option>
                            <option value="moderate" {% if gaps.fit_assessment.scaffolding_recommendation == 'moderate' %}selected{% endif %}>Moderate - Regular guidance</option>
                            <option value="significant" {% if gaps.fit_assessment.scaffolding_recommendation == 'significant' %}selected{% endif %}>Significant - Detailed structure</option>
                        </select>
                    </div>

                    <!-- Strong Matches -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center">
                                <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                Strong Matches
                            </span>
                        </label>
                        <div class="space-y-2" id="strong-matches">
                            {% for match in gaps.strong_matches %}
                                <div class="flex items-center text-sm bg-green-50 border border-green-200 rounded-lg p-2">
                                    <span class="text-green-700">{{ match.learner_skill }}</span>
                                    <svg class="w-4 h-4 mx-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                    </svg>
                                    <span class="text-green-700">{{ match.project_need }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Skill Gaps -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="inline-flex items-center">
                                <svg class="w-4 h-4 text-amber-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                Skill Gaps (Development Areas)
                            </span>
                        </label>
                        <div class="space-y-2" id="skill-gaps">
                            {% for gap in gaps.skill_gaps %}
                                <div class="flex items-start text-sm bg-amber-50 border border-amber-200 rounded-lg p-2">
                                    <input type="checkbox" checked class="mt-1 mr-2 rounded border-gray-300 text-primary focus:ring-primary">
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between gap-2">
                                            <span class="font-medium text-amber-800">{{ gap.project_need }}</span>
                                            {% if gap.importance %}
                                            <span class="text-xs px-2 py-0.5 {% if gap.importance == 'critical' %}bg-red-200 text-red-700{% elif gap.importance == 'important' %}bg-amber-200 text-amber-700{% else %}bg-gray-200 text-gray-600{% endif %} rounded flex-shrink-0">{{ gap.importance }}</span>
                                            {% endif %}
                                        </div>
                                        <p class="text-amber-700 text-xs mt-1">{{ gap.description or '' }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Key Development Areas -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Key Focus Areas</label>
                        <div class="skill-tags flex flex-wrap gap-2" id="development-areas">
                            {% for area in gaps.fit_assessment.key_development_areas %}
                                <span class="skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-indigo-100 text-indigo-800 border border-indigo-200">
                                    {{ area }}
                                    <button type="button" class="ml-2 text-indigo-600 hover:text-indigo-800" onclick="removeTag(this)">&times;</button>
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Standard Learning Objectives Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6">
            <div class="flex items-center mb-4">
                <div class="bg-indigo-100 rounded-lg p-2 mr-3">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Standard Learning Objectives</h2>
                    <p class="text-sm text-gray-500">Transferable professional skills included in this course</p>
                </div>
            </div>

            <p class="text-sm text-gray-600 mb-4">These foundational skills apply to most experiential learning projects. Uncheck any that don't apply to this specific project.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="fixed-objectives">
                {% set objectives = raw.institution.fixed_objectives or ['project_management', 'professional_communication', 'time_management', 'critical_thinking', 'collaboration', 'self_reflection'] %}

                <label class="inline-flex items-start p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 cursor-pointer border border-indigo-200">
                    <input type="checkbox" name="fixed_objectives" value="project_management"
                           {% if 'project_management' in objectives %}checked{% endif %}
                           class="mt-0.5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div class="ml-3">
                        <span class="text-sm font-medium text-indigo-800">Project Management</span>
                        <p class="text-xs text-indigo-600">Planning, organizing, and executing work</p>
                    </div>
                </label>

                <label class="inline-flex items-start p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 cursor-pointer border border-indigo-200">
                    <input type="checkbox" name="fixed_objectives" value="professional_communication"
                           {% if 'professional_communication' in objectives %}checked{% endif %}
                           class="mt-0.5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div class="ml-3">
                        <span class="text-sm font-medium text-indigo-800">Professional Communication</span>
                        <p class="text-xs text-indigo-600">Written and verbal workplace communication</p>
                    </div>
                </label>

                <label class="inline-flex items-start p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 cursor-pointer border border-indigo-200">
                    <input type="checkbox" name="fixed_objectives" value="time_management"
                           {% if 'time_management' in objectives %}checked{% endif %}
                           class="mt-0.5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div class="ml-3">
                        <span class="text-sm font-medium text-indigo-800">Time Management</span>
                        <p class="text-xs text-indigo-600">Meeting deadlines and managing priorities</p>
                    </div>
                </label>

                <label class="inline-flex items-start p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 cursor-pointer border border-indigo-200">
                    <input type="checkbox" name="fixed_objectives" value="critical_thinking"
                           {% if 'critical_thinking' in objectives %}checked{% endif %}
                           class="mt-0.5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div class="ml-3">
                        <span class="text-sm font-medium text-indigo-800">Critical Thinking</span>
                        <p class="text-xs text-indigo-600">Problem-solving and analytical reasoning</p>
                    </div>
                </label>

                <label class="inline-flex items-start p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 cursor-pointer border border-indigo-200">
                    <input type="checkbox" name="fixed_objectives" value="collaboration"
                           {% if 'collaboration' in objectives %}checked{% endif %}
                           class="mt-0.5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div class="ml-3">
                        <span class="text-sm font-medium text-indigo-800">Collaboration & Teamwork</span>
                        <p class="text-xs text-indigo-600">Working effectively with others</p>
                    </div>
                </label>

                <label class="inline-flex items-start p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 cursor-pointer border border-indigo-200">
                    <input type="checkbox" name="fixed_objectives" value="self_reflection"
                           {% if 'self_reflection' in objectives %}checked{% endif %}
                           class="mt-0.5 rounded border-gray-300 text-primary focus:ring-primary">
                    <div class="ml-3">
                        <span class="text-sm font-medium text-indigo-800">Self-Reflection</span>
                        <p class="text-xs text-indigo-600">Metacognition and growth mindset</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Hidden JSON fields for form submission -->
        <input type="hidden" name="confirmed_skills" id="confirmed_skills_input">
        <input type="hidden" name="confirmed_coursework" id="confirmed_coursework_input">
        <input type="hidden" name="confirmed_deliverables" id="confirmed_deliverables_input">
        <input type="hidden" name="confirmed_technical_skills" id="confirmed_technical_skills_input">
        <input type="hidden" name="confirmed_professional_skills" id="confirmed_professional_skills_input">
        <input type="hidden" name="confirmed_domain_knowledge" id="confirmed_domain_knowledge_input">
        <input type="hidden" name="confirmed_success_criteria" id="confirmed_success_criteria_input">
        <input type="hidden" name="strong_matches" id="strong_matches_input">
        <input type="hidden" name="skill_gaps" id="skill_gaps_input">
        <input type="hidden" name="learning_preferences" id="learning_preferences_input" value="{{ raw.learner.learning_preferences|tojson }}">

        <!-- Action Buttons -->
        <div class="flex justify-between mt-8">
            <a href="{{ url_for('intake_form') }}" class="px-6 py-3 text-gray-600 hover:text-gray-800 font-medium">
                &larr; Go Back & Edit Inputs
            </a>
            <button type="submit" id="generateBtn" class="px-8 py-3 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                <span id="generateText">Generate Objectives & Assessment &rarr;</span>
                <span id="generatingText" class="hidden">
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading...
                </span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Collect tags from a container
    function collectTags(containerId) {
        const container = document.getElementById(containerId);
        const tags = container.querySelectorAll('.skill-tag');
        return Array.from(tags).map(tag => {
            // Get text content excluding the remove button
            const text = tag.childNodes[0].textContent.trim();
            return text;
        });
    }

    // Collect deliverables
    function collectDeliverables() {
        const items = document.querySelectorAll('#deliverables-list .deliverable-item input');
        return Array.from(items).map(input => input.value.trim()).filter(v => v);
    }

    // Collect checked skill gaps
    function collectSkillGaps() {
        const gaps = [];
        document.querySelectorAll('#skill-gaps > div').forEach(div => {
            const checkbox = div.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                const skillName = div.querySelector('.font-medium').textContent.trim();
                const importanceBadge = div.querySelector('[class*="rounded flex-shrink-0"]');
                const importance = importanceBadge ? importanceBadge.textContent.trim() : 'important';
                const descEl = div.querySelector('.text-xs.mt-1');
                const description = descEl ? descEl.textContent.trim() : '';
                gaps.push({
                    project_need: skillName,
                    importance: importance,
                    description: description
                });
            }
        });
        return gaps;
    }

    // Collect strong matches
    function collectStrongMatches() {
        const matches = [];
        document.querySelectorAll('#strong-matches > div').forEach(div => {
            const spans = div.querySelectorAll('span');
            if (spans.length >= 2) {
                matches.push({
                    learner_skill: spans[0].textContent.trim(),
                    project_need: spans[1].textContent.trim()
                });
            }
        });
        return matches;
    }

    // Remove tag
    function removeTag(button) {
        button.parentElement.remove();
    }

    // Add new tag
    function addTag(containerId, color) {
        const container = document.getElementById(containerId);
        const addBtn = container.querySelector('.add-tag-btn');

        const newTag = document.createElement('span');
        newTag.className = `skill-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-${color}-100 text-${color}-800 border border-${color}-200`;
        newTag.innerHTML = `
            <input type="text" class="bg-transparent border-none outline-none w-24 text-sm" placeholder="New skill..." autofocus>
            <button type="button" class="ml-2 text-${color}-600 hover:text-${color}-800" onclick="removeTag(this)">&times;</button>
        `;

        container.insertBefore(newTag, addBtn);

        const input = newTag.querySelector('input');
        input.focus();

        input.addEventListener('blur', function() {
            if (this.value.trim()) {
                const textNode = document.createTextNode(this.value.trim());
                newTag.insertBefore(textNode, newTag.firstChild);
                this.remove();
            } else {
                newTag.remove();
            }
        });

        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
            }
        });
    }

    // Remove deliverable
    function removeDeliverable(button) {
        button.parentElement.remove();
    }

    // Add deliverable
    function addDeliverable() {
        const list = document.getElementById('deliverables-list');
        const newItem = document.createElement('div');
        newItem.className = 'deliverable-item flex items-center gap-2 bg-gray-50 p-2 rounded-lg';
        newItem.innerHTML = `
            <span class="text-gray-400 cursor-move">&#9776;</span>
            <input type="text" class="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="New deliverable...">
            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeDeliverable(this)">&times;</button>
        `;
        list.appendChild(newItem);
        newItem.querySelector('input').focus();
    }

    // Form submission
    document.getElementById('confirmForm').addEventListener('submit', function(e) {
        // Collect all data and set hidden inputs
        const technicalSkills = collectTags('technical-skills');
        const professionalSkills = collectTags('professional-skills');
        const allSkills = technicalSkills.map(s => ({skill: s, type: 'technical'}))
            .concat(professionalSkills.map(s => ({skill: s, type: 'professional'})));

        document.getElementById('confirmed_skills_input').value = JSON.stringify(allSkills);
        document.getElementById('confirmed_coursework_input').value = JSON.stringify(collectTags('coursework'));
        document.getElementById('confirmed_deliverables_input').value = JSON.stringify(collectDeliverables());
        document.getElementById('confirmed_technical_skills_input').value = JSON.stringify(collectTags('project-technical-skills'));
        document.getElementById('confirmed_professional_skills_input').value = JSON.stringify([]);
        document.getElementById('confirmed_domain_knowledge_input').value = JSON.stringify([]);
        document.getElementById('confirmed_success_criteria_input').value = JSON.stringify(collectTags('success-criteria'));
        document.getElementById('strong_matches_input').value = JSON.stringify(collectStrongMatches());
        document.getElementById('skill_gaps_input').value = JSON.stringify(collectSkillGaps());

        // Show loading state
        const btn = document.getElementById('generateBtn');
        const generateText = document.getElementById('generateText');
        const generatingText = document.getElementById('generatingText');

        btn.disabled = true;
        generateText.classList.add('hidden');
        generatingText.classList.remove('hidden');
    });
</script>
{% endblock %}
